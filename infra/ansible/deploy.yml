- name: Deploy CafeLove App
  hosts: web
  become: yes

  vars:
    app_dir: /opt/cafelove
    backend_image: "hima1222/cafelove-backend:latest"
    frontend_image: "hima1222/cafelove-frontend:latest"
    docker_registry_user: "{{ docker_user }}"
    docker_registry_pass: "{{ docker_pass }}"

  pre_tasks:
    - name: Ensure python is installed for docker modules (RedHat)
      raw: test -e /usr/bin/python || (yum -y install python2 || apt-get -y update && apt-get -y install python-minimal)
      changed_when: false

    - name: Install docker on Amazon Linux / RHEL
      block:
        - name: Install required packages (yum)
          yum:
            name: ["yum-utils", "device-mapper-persistent-data", "lvm2"]
            state: present
            update_cache: yes
          when: ansible_os_family == 'RedHat'

        - name: Add docker repo and install docker-ce
          shell: |
            amazon-linux-extras install -y docker || true
            yum install -y docker || true
          when: ansible_os_family == 'RedHat'

    - name: Install docker on Debian/Ubuntu
      block:
        - name: Install apt packages
          apt:
            name: ["apt-transport-https", "ca-certificates", "curl", "gnupg", "lsb-release"]
            state: present
            update_cache: yes
          when: ansible_os_family == 'Debian'

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          when: ansible_os_family == 'Debian'

        - name: Add Docker apt repository
          apt_repository:
            repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
            state: present
          when: ansible_os_family == 'Debian'

        - name: Install docker-ce
          apt:
            name: docker-ce
            state: present
            update_cache: yes
          when: ansible_os_family == 'Debian'

    - name: Ensure docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Install Docker Compose
      get_url:
        url: "https://github.com/docker/compose/releases/latest/download/docker-compose-{{ ansible_system }}-{{ ansible_machine }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Add ec2-user to docker group
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Login to Docker Hub
      shell: echo "{{ docker_registry_pass }}" | docker login -u "{{ docker_registry_user }}" --password-stdin
      no_log: true

  tasks:
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
        owner: ec2-user
        group: ec2-user

    - name: Copy docker-compose.prod.yaml
      copy:
        src: ../../docker-compose.prod.yaml
        dest: "{{ app_dir }}/docker-compose.prod.yaml"
        owner: ec2-user
        group: ec2-user
        mode: '0644'

    - name: Copy deployment script
      copy:
        src: ../scripts/ec2-deploy.sh
        dest: "{{ app_dir }}/deploy.sh"
        owner: ec2-user
        group: ec2-user
        mode: '0755'

    - name: Copy systemd service
      copy:
        src: ../scripts/cafelove.service
        dest: /etc/systemd/system/cafelove.service
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Pull backend image with retry
      shell: docker pull {{ backend_image }}
      retries: 3
      delay: 10
      register: backend_pull
      until: backend_pull.rc == 0

    - name: Pull frontend image with retry
      shell: docker pull {{ frontend_image }}
      retries: 3
      delay: 10
      register: frontend_pull
      until: frontend_pull.rc == 0

    - name: Stop old containers
      shell: cd {{ app_dir }} && docker-compose -f docker-compose.prod.yaml down
      ignore_errors: yes

    - name: Start new containers
      shell: cd {{ app_dir }} && docker-compose -f docker-compose.prod.yaml up -d
      become_user: ec2-user

    - name: Wait for backend to become healthy
      uri:
        url: "http://localhost:5000/api/test"
        method: GET
        status_code: 200
      register: result
      until: result.status == 200
      retries: 15
      delay: 5

    - name: Enable and start CafeLove service
      systemd:
        name: cafelove
        enabled: yes
        state: started
        daemon_reload: yes

  post_tasks:
    - name: Get EC2 IP address
      shell: hostname -I | awk '{print $1}'
      register: ec2_ip

    - name: Display deployment success
      debug:
        msg:
          - "========================================="
          - "CafeLove Deployed Successfully!"
          - "========================================="
          - "Frontend:  http://{{ ec2_ip.stdout }}"
          - "Backend:   http://{{ ec2_ip.stdout }}:5000/api/test"
          - "Status:    sudo systemctl status cafelove"
          - "Logs:      sudo journalctl -u cafelove -f"
          - "========================================="

