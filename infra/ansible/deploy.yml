- name: Deploy CafeLove App
  hosts: web
  become: yes

  vars:
    backend_image: "hima1222/cafelove-backend:latest"
    frontend_image: "hima1222/cafelove-frontend:latest"
    backend_container_name: cafelove-backend
    frontend_container_name: cafelove-frontend

  pre_tasks:
    - name: Ensure python is installed for docker modules (RedHat)
      raw: test -e /usr/bin/python || (yum -y install python2 || apt-get -y update && apt-get -y install python-minimal)
      changed_when: false

    - name: Install docker on Amazon Linux / RHEL
      block:
        - name: Install required packages (yum)
          yum:
            name: ["yum-utils", "device-mapper-persistent-data", "lvm2"]
            state: present
            update_cache: yes
          when: ansible_os_family == 'RedHat'

        - name: Add docker repo and install docker-ce
          shell: |
            amazon-linux-extras install -y docker || true
            yum install -y docker || true
          when: ansible_os_family == 'RedHat'

    - name: Install docker on Debian/Ubuntu
      block:
        - name: Install apt packages
          apt:
            name: ["apt-transport-https", "ca-certificates", "curl", "gnupg", "lsb-release"]
            state: present
            update_cache: yes
          when: ansible_os_family == 'Debian'

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          when: ansible_os_family == 'Debian'

        - name: Add Docker apt repository
          apt_repository:
            repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable
            state: present
          when: ansible_os_family == 'Debian'

        - name: Install docker-ce
          apt:
            name: docker-ce
            state: present
            update_cache: yes
          when: ansible_os_family == 'Debian'

    - name: Ensure docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Login to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_user }}"
        password: "{{ docker_pass }}"

  tasks:
    - name: Pull backend image with retry
      community.docker.docker_image:
        name: "{{ backend_image }}"
        source: pull
      retries: 3
      delay: 10
      register: backend_pull_result
      until: backend_pull_result is succeeded

    - name: Pull frontend image with retry
      community.docker.docker_image:
        name: "{{ frontend_image }}"
        source: pull
      retries: 3
      delay: 10
      register: frontend_pull_result
      until: frontend_pull_result is succeeded

    - name: Stop and remove backend container if exists
      community.docker.docker_container:
        name: "{{ backend_container_name }}"
        state: absent
        force_kill: yes

    - name: Stop and remove frontend container if exists
      community.docker.docker_container:
        name: "{{ frontend_container_name }}"
        state: absent
        force_kill: yes

    - name: Run backend container
      community.docker.docker_container:
        name: "{{ backend_container_name }}"
        image: "{{ backend_image }}"
        state: started
        restart_policy: always
        published_ports:
          - "5000:5000"

    - name: Run frontend container
      community.docker.docker_container:
        name: "{{ frontend_container_name }}"
        image: "{{ frontend_image }}"
        state: started
        restart_policy: always
        published_ports:
          - "80:5173"

  post_tasks:
    - name: Display deployment success message
      debug:
        msg:
          - "========================================="
          - "âœ“ CafeLove Deployment Completed!"
          - "Backend: {{ backend_container_name }} running on port 5000"
          - "Frontend: {{ frontend_container_name }} running on port 80"
          - "========================================="

    - name: Wait for backend container to be healthy
      community.docker.docker_container:
        name: "{{ backend_container_name }}"
        state: started
      register: backend_status

    - name: Verify backend is responding
      uri:
        url: "http://localhost:5000/api/test"
        method: GET
        status_code: [200, 404, 500]
      ignore_errors: yes
      retries: 3
      delay: 5
      register: backend_health

    - name: Display backend health status
      debug:
        msg: "Backend API responding: {{ backend_health.status | default('Unable to reach') }}"
